name: ğŸ§ª Quality Check Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]

jobs:
  pre-push-checks:
    name: ğŸš€ Pre-Push Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸš€ Run comprehensive pre-push checks
        run: bun run pre-push --skip-git
        env:
          CI: true

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            test-results/
          retention-days: 30

  build-check:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: pre-push-checks

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ—ï¸ Build application
        run: bun run build
        env:
          CI: true

      - name: ğŸ“Š Build size analysis
        run: |
          echo "ğŸ“Š Build completed successfully!"
          if [ -d ".next" ]; then
            echo "ğŸ“¦ Build artifacts created"
            du -sh .next/ || echo "No .next directory found"
          fi

  # Optional: Security audit (runs in parallel)
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true # Don't fail the pipeline on security warnings

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ” Security audit
        run: bun audit || echo "âš ï¸ Security audit completed with warnings"

  # Summary job that other workflows can depend on
  ci-success:
    name: âœ… CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [pre-push-checks, build-check]
    if: always()

    steps:
      - name: ğŸ‰ All checks passed
        if: needs.pre-push-checks.result == 'success' && needs.build-check.result == 'success'
        run: |
          echo "ğŸ‰ All quality checks and build verification passed!"
          echo "âœ… This PR is ready for review and merge."
          echo "ğŸš€ Deployment will be handled automatically by Vercel."

      - name: âŒ Some checks failed
        if: needs.pre-push-checks.result != 'success' || needs.build-check.result != 'success'
        run: |
          echo "âŒ Some checks failed. Please review the failed jobs above."
          echo "ğŸ”§ Run 'bun run pre-push --fix' locally to auto-fix common issues."
          exit 1